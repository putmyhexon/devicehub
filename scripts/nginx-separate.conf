worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    server {
        server_name pve.putmyhexon.ru;

        client_max_body_size 1024M;

        resolver 192.168.0.1;

        location / {
            proxy_pass https://192.168.0.100:8006;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }


        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/devicehub.putmyhexon.ru/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/devicehub.putmyhexon.ru/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }

    server {
        server_name ldap.putmyhexon.ru;

        client_max_body_size 1024M;

        resolver 192.168.0.1;

        location / {
            proxy_pass https://192.168.0.103;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }


        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/devicehub.putmyhexon.ru/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/devicehub.putmyhexon.ru/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }

    server {
        server_name portainer.putmyhexon.ru;

        client_max_body_size 1024M;

        resolver 192.168.0.1;

        location / {
            proxy_pass https://192.168.0.101:9443;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/devicehub.putmyhexon.ru/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/devicehub.putmyhexon.ru/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }

    server {
        server_name devicehub.putmyhexon.ru;

        client_max_body_size 1024M;

        resolver 192.168.0.1;

        location = /auth {
            proxy_pass http://192.168.0.102:3100;
        }

        # Use this if you have provider is in the docker network.
        # WARNING: This allows direct access to any host in the network. Use with caution.
        location ~ ^/d/(?<stfprovider>[^/]+)/(?<port>[0-9]+)/$ {
            proxy_pass http://192.168.0.102:$port/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /auth/ {
            proxy_pass http://192.168.0.102:3200;
        }

        location /api/ {
            proxy_pass http://192.168.0.102:3700;
        }

        location /s/image/ {
            proxy_pass http://192.168.0.102:3300;
        }

        location /s/apk/ {
            proxy_pass http://192.168.0.102:3400;
        }

        location /s/ {
            client_max_body_size 2048m;
            client_body_buffer_size 128k;
            proxy_pass http://192.168.0.102:3500;
        }

        location /socket.io/ {
            proxy_pass http://192.168.0.102:3600;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection upgrade;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $http_x_real_ip;
        }

        location / {
            proxy_pass http://192.168.0.102:3100;
        }

        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/devicehub.putmyhexon.ru/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/devicehub.putmyhexon.ru/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }


    server {
        if ($host = devicehub.putmyhexon.ru) {
            return 301 https://$host$request_uri;
        } # managed by Certbot


        listen 80;
        server_name devicehub.putmyhexon.ru;
        return 404; # managed by Certbot
    }

    server {
        if ($host = portainer.putmyhexon.ru) {
            return 301 https://$host$request_uri;
        } # managed by Certbot


        listen 80;
        server_name portainer.putmyhexon.ru;
        return 404; # managed by Certbot
    }


    server {
        if ($host = ldap.putmyhexon.ru) {
            return 301 https://$host$request_uri;
        } # managed by Certbot


        server_name ldap.putmyhexon.ru;
        listen 80;
        return 404; # managed by Certbot
    }
    server {
        if ($host = pve.putmyhexon.ru) {
            return 301 https://$host$request_uri;
        } # managed by Certbot


        server_name pve.putmyhexon.ru;
        listen 80;
        return 404; # managed by Certbot
    }
}